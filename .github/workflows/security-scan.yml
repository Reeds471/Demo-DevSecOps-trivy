name: üõ°Ô∏è Security Guard (DevSecOps)

# D√©clencheur : Quand on pousse du code ou qu'on fait une Pull Request
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  security-check:
    name: üîç Trivy Vulnerability Scanner
    runs-on: ubuntu-latest
    steps:
      # 1. R√©cup√©rer le code du d√©p√¥t
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Construire l'image Docker (sans la pousser) pour l'analyser
      - name: Build Docker Image
        run: docker build -t my-app:vulnerable .

      # 3. Lancer le scanneur de s√©curit√© TRIVY
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'my-app:vulnerable'
          format: 'table'
          # On ne bloque que si la s√©v√©rit√© est CRITIQUE ou HAUTE
          severity: 'CRITICAL,HIGH'
          # Code 1 = Fait √©chouer la pipeline si des failles sont trouv√©es
          exit-code: '1'
      
      # Si Trivy trouve des failles, on veut quand m√™me g√©n√©rer le rapport avant de quitter
      - name: Run Trivy (Report only)
        if: always() 
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'my-app:vulnerable'
          format: 'table'
          output: 'security-report.txt' # On √©crit dans un fichier

      - name: Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rapport-securite
          path: security-report.txt
